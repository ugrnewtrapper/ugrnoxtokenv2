export default {
async fetch(request) {

/* ========= CORS (CORREÇÃO OBRIGATÓRIA) ========= /
if (request.method === "OPTIONS") {
return new Response(null, {
status: 204,
headers: {
"Access-Control-Allow-Origin": "",
"Access-Control-Allow-Methods": "POST, OPTIONS",
"Access-Control-Allow-Headers": "Content-Type"
}
});
}

if (request.method !== "POST") {
return new Response(
JSON.stringify({ error: "Use POST" }),
{
status: 405,
headers: {
"Content-Type": "application/json",
"Access-Control-Allow-Origin": "*"
}
}
);
}

const body = await request.json();
const { apiKey, date, fixtureId } = body;

if (!apiKey || !date) {
return new Response(
JSON.stringify({ error: "apiKey e date são obrigatórios" }),
{
status: 400,
headers: {
"Content-Type": "application/json",
"Access-Control-Allow-Origin": "*"
}
}
);
}

const BASE_URL = "https://v3.football.api-sports.io";
const HEADERS = { "x-apisports-key": apiKey };

/* ================= HELPERS ================= */
const sleep = ms => new Promise(r => setTimeout(r, ms));

const requestGet = async (url, params = {}, tries = 3) => {
let lastErr;
for (let i = 0; i < tries; i++) {
try {
const qs = new URLSearchParams(params).toString();
const res = await fetch(${url}?${qs}, { headers: HEADERS });
return await res.json();
} catch (e) {
lastErr = e;
await sleep(400 * (i + 1));
}
}
throw lastErr;
};

/* ==========================================================

1. MODO LISTAGEM → COMPETIÇÕES + PARTIDAS
========================================================== */
if (!fixtureId) {
const fxData = await requestGet(${BASE_URL}/fixtures, { date });
const fixtures = fxData.response || [];



if (!fixtures.length) {
return new Response(
JSON.stringify({ competitions: [] }),
{
headers: {
"Content-Type": "application/json",
"Access-Control-Allow-Origin": "*"
}
}
);
}

const competitions = {};

for (const fx of fixtures) {
const league = fx.league;
const lid = league.id;

if (!competitions[lid]) {    
  competitions[lid] = {    
    leagueId: lid,    
    league: league.name,    
    country: league.country || "",    
    matches: []    
  };    
}    

competitions[lid].matches.push({    
  fixtureId: fx.fixture.id,    
  home: fx.teams.home.name,    
  away: fx.teams.away.name,    
  time: fx.fixture.date?.substring(11, 16) || ""    
});

}

return new Response(
JSON.stringify({ competitions: Object.values(competitions) }),
{
headers: {
"Content-Type": "application/json",
"Access-Control-Allow-Origin": "*"
}
}
);
}

/* ==========================================================
2) MODO ANÁLISE → FIXTURE + H2H + MÉDIAS
========================================================== */

const fxData = await requestGet(${BASE_URL}/fixtures, { id: fixtureId });
const fx = fxData.response?.[0];

if (!fx) {
return new Response(
JSON.stringify({ error: "Fixture não encontrada" }),
{
status: 404,
headers: {
"Content-Type": "application/json",
"Access-Control-Allow-Origin": "*"
}
}
);
}

const home = fx.teams.home.name;
const away = fx.teams.away.name;
const homeId = fx.teams.home.id;
const awayId = fx.teams.away.id;

/* ================= H2H ROBUSTO ================= */
const baseH2H = ${BASE_URL}/fixtures/headtohead;
let h2h = [];

const tryH2H = async (a, b) =>
(await requestGet(baseH2H, { h2h: ${a}-${b}, last: 30 })).response || [];

h2h = await tryH2H(homeId, awayId);
if (!h2h.length) h2h = await tryH2H(awayId, homeId);

if (!h2h.length) {
return new Response(
JSON.stringify({ error: "Sem histórico H2H" }),
{
headers: {
"Content-Type": "application/json",
"Access-Control-Allow-Origin": "*"
}
}
);
}

const collect = {
tg: [], gc: [], gv: [], esc: [], ght: [], ghtc: [], ghtv: [], cart: []
};

for (const f of h2h) {
const gh = f.goals?.home;
const ga = f.goals?.away;
if (gh != null && ga != null) {
collect.tg.push(gh + ga);
collect.gc.push(gh);
collect.gv.push(ga);
}

const ht = f.score?.halftime;
if (ht?.home != null && ht?.away != null) {
collect.ght.push(ht.home + ht.away);
collect.ghtc.push(ht.home);
collect.ghtv.push(ht.away);
}

collect.cart.push(
(f.events || []).filter(e =>
(e.type || "").toLowerCase().includes("card")
).length
);
}

const mean = arr =>
arr.length
? Number((arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(2))
: null;

return new Response(
JSON.stringify({
home,
away,
h2hGames: h2h.length,
means: {
"Total de gols (partida)": mean(collect.tg),
"Casa total de gols": mean(collect.gc),
"Visitante total de gols": mean(collect.gv),
"Total de escanteios": mean(collect.esc),
"Gols 1º tempo total": mean(collect.ght),
"Gols 1º tempo casa": mean(collect.ghtc),
"Gols 1º tempo visitante": mean(collect.ghtv),
"Cartões total": mean(collect.cart)
}
}),
{
headers: {
"Content-Type": "application/json",
"Access-Control-Allow-Origin": "*"
}
}
);

}
};
