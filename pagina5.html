<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Teste Wallet V12</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
  <h2>Teste Wallet V12 – Futebol</h2>

  <!-- API KEY -->
  <div>
    <label>API-Football Key:</label><br />
    <input id="apiKey" type="text" placeholder="API KEY" />
  </div>

  <br />

  <!-- DATA -->
  <div>
    <label>Data:</label><br />
    <input id="date" type="date" />
  </div>

  <br />

  <!-- BOTÃO CARREGAR -->
  <button id="btnLoad">Carregar partidas</button>

  <hr />

  <!-- LISTA DE PARTIDAS -->
  <div id="matches"></div>

  <hr />

  <!-- TX HASH -->
  <div>
    <label>TX Hash (pagamento já feito):</label><br />
    <input id="txHash" type="text" style="width: 100%;" />
  </div>

  <br />

  <!-- BOTÃO ANALISAR -->
  <button id="btnAnalyze" disabled>Analisar</button>

  <hr />

  <!-- STATUS -->
  <pre id="status"></pre>

  <script type="module">
    import { validatePaymentAndRequestAnalysis } from "./money/walletv12.js";

    const BACKEND_URL = "https://backendv12.srrimas2017.workers.dev";

    const apiKeyInput = document.getElementById("apiKey");
    const dateInput = document.getElementById("date");
    const matchesDiv = document.getElementById("matches");
    const txHashInput = document.getElementById("txHash");
    const btnAnalyze = document.getElementById("btnAnalyze");
    const statusBox = document.getElementById("status");

    let selectedFixtureId = null;

    // CARREGAR PARTIDAS
    document.getElementById("btnLoad").onclick = async () => {
      statusBox.textContent = "Carregando partidas...";
      matchesDiv.innerHTML = "";
      btnAnalyze.disabled = true;
      selectedFixtureId = null;

      try {
        const res = await fetch(`${BACKEND_URL}/api/partidas`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            apiKey: apiKeyInput.value,
            date: dateInput.value
          })
        });

        const json = await res.json();

        if (!res.ok || json.error) {
          throw new Error(json.message || "Erro ao carregar partidas");
        }

        json.data.forEach(f => {
          const div = document.createElement("div");
          div.innerHTML = `
            <label>
              <input type="radio" name="fixture" value="${f.fixture.id}">
              ${f.teams.home.name} x ${f.teams.away.name}
            </label>
          `;
          div.querySelector("input").onchange = () => {
            selectedFixtureId = f.fixture.id;
            btnAnalyze.disabled = false;
          };
          matchesDiv.appendChild(div);
        });

        statusBox.textContent = "Partidas carregadas.";
      } catch (err) {
        statusBox.textContent = "Erro: " + err.message;
      }
    };

    // ANALISAR (WALLET V12)
    btnAnalyze.onclick = async () => {
      statusBox.textContent = "Validando pagamento via Wallet V12...";

      try {
        await validatePaymentAndRequestAnalysis({
          apiKey: apiKeyInput.value,
          fixtureId: selectedFixtureId,
          txHash: txHashInput.value
        });

        statusBox.textContent = "✅ ANÁLISE LIBERADA (Wallet V12 OK)";
      } catch (err) {
        statusBox.textContent = "❌ ERRO: " + err.message;
      }
    };
  </script>
</body>
</html>
