<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>V12 – HTML de Teste</title>

  <!-- ethers (obrigatório) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#0f1216; color:#e6e6e6; padding:20px; }
    input, select, button { padding:8px; margin:5px 0; width:100%; }
    button { cursor:pointer; background:#1f6feb; color:#fff; border:none; }
    .box { background:#151a21; padding:15px; margin-bottom:15px; border-radius:6px; }
    .log { font-size:12px; background:#000; padding:10px; margin-top:10px; height:150px; overflow:auto; }
  </style>
</head>
<body>

  <h2>V12 – HTML de Teste (Auditado)</h2>

  <div class="box">
    <label>API Key (API-Football)</label>
    <input id="apiKey" placeholder="Cole sua API Key aqui" />
  </div>

  <div class="box">
    <label>Data da Partida</label>
    <input type="date" id="date" />
    <button id="loadMatches">Carregar partidas</button>
  </div>

  <div class="box">
    <label>Partida</label>
    <select id="fixtureSelect">
      <option value="">Selecione uma partida</option>
    </select>
  </div>

  <div class="box">
    <button id="connectWallet">Conectar Carteira</button>
    <button id="analyze">Analisar (Pagamento + Análise)</button>
  </div>

  <div class="box">
    <strong>Log</strong>
    <div class="log" id="log"></div>
  </div>

  <!-- Wallet V12 -->
  <script type="module">
    import { WalletV12 } from "./money/walletv12.js";

    const API_BASE = "https://backendnoxv22.srrimas2017.workers.dev";

    const wallet = new WalletV12();

    const log = msg => {
      const el = document.getElementById("log");
      el.innerHTML += msg + "<br>";
      el.scrollTop = el.scrollHeight;
    };

    document.getElementById("connectWallet").onclick = async () => {
      try {
        const user = await wallet.connect();
        log("Carteira conectada: " + user);
      } catch (e) {
        log("Erro carteira: " + e.message);
      }
    };

    document.getElementById("loadMatches").onclick = async () => {
      const apiKey = document.getElementById("apiKey").value;
      const date = document.getElementById("date").value;

      if (!apiKey || !date) {
        log("API Key ou data ausente");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/partidas`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ apiKey, date })
        });

        const json = await res.json();
        const select = document.getElementById("fixtureSelect");
        select.innerHTML = '<option value="">Selecione uma partida</option>';

        json.data.forEach(f => {
          const opt = document.createElement("option");
          opt.value = f.fixture.id;
          opt.textContent = `${f.teams.home.name} x ${f.teams.away.name}`;
          select.appendChild(opt);
        });

        log("Partidas carregadas");
      } catch (e) {
        log("Erro ao carregar partidas");
      }
    };

    document.getElementById("analyze").onclick = async () => {
      const apiKey = document.getElementById("apiKey").value;
      const fixtureId = document.getElementById("fixtureSelect").value;

      if (!apiKey || !fixtureId) {
        log("API Key ou partida ausente");
        return;
      }

      try {
        log("Iniciando pagamento...");
        const payment = await wallet.pay();

        log("Pagamento confirmado. TX: " + payment.txHash);

        const res = await fetch(`${API_BASE}/api/analisar`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            apiKey,
            fixtureId: Number(fixtureId),
            txHash: payment.txHash
          })
        });

        const json = await res.json();
        log("Análise concluída:");
        log(JSON.stringify(json, null, 2));
      } catch (e) {
        log("Erro análise: " + e.message);
      }
    };
  </script>

</body>
</html>
