<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Teste API-Football + Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }

    h1 { margin-bottom: 10px; }

    button {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .primary { background: #2563eb; color: #fff; }
    .success { background: #16a34a; color: #fff; }
    .warning { background: #ca8a04; color: #000; }
    .info    { background: #0ea5e9; color: #000; }

    pre {
      background: #020617;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
    }

    .box {
      background: #020617;
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<h1>‚öΩ Teste API-Football + Wallet</h1>

<button id="btnWallet" class="primary">üîå Conectar Wallet</button>
<button id="btnSearch" class="info" disabled>üîç Buscar Jogo Aleat√≥rio</button>
<button id="btnPay" class="warning" disabled>üí≥ Comprar An√°lise</button>
<button id="btnAnalyze" class="success" disabled>üìä Ver An√°lise</button>

<div class="box">
  <strong>Status:</strong>
  <pre id="status">Aguardando...</pre>
</div>

<div class="box">
  <strong>Resposta:</strong>
  <pre id="output"></pre>
</div>

<script type="module">
  import { connectWallet, payForAnalysis } from "/money/walletv12.js";

  const API_KEY = "44154acf83f7568c7b0e75e10676a2dd";
  const BACKEND = "https://backendv12.srrimas2017.workers.dev";

  let wallet = null;
  let fixtureId = null;
  let txHash = null;

  const status = (msg) =>
    document.getElementById("status").textContent = msg;

  const output = (data) =>
    document.getElementById("output").textContent =
      JSON.stringify(data, null, 2);

  // 1Ô∏è‚É£ WALLET
  document.getElementById("btnWallet").onclick = async () => {
    status("üîå Conectando wallet...");
    try {
      wallet = await connectWallet();
      status(`üëõ Wallet conectada:\n${wallet}`);
      document.getElementById("btnSearch").disabled = false;
    } catch (e) {
      status("‚ùå Erro ao conectar wallet");
    }
  };

  // 2Ô∏è‚É£ PESQUISA ALEAT√ìRIA
  document.getElementById("btnSearch").onclick = async () => {
    status("üîç Buscando fixtures do dia...");
    document.getElementById("btnSearch").disabled = true;

    const date = new Date().toISOString().split("T")[0];

    const res = await fetch(`${BACKEND}/competitions`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ apiKey: API_KEY, date })
    });

    const json = await res.json();
    output(json);

    // pega fixture aleat√≥rio
    const leagues = Object.values(json.data || {});
    const randomLeague = leagues[Math.floor(Math.random() * leagues.length)];
    const randomFixture = randomLeague.fixtures[0];

    fixtureId = randomFixture.fixtureId;

    status(`üéØ Fixture selecionado: ${fixtureId}`);
    document.getElementById("btnPay").disabled = false;
  };

  // 3Ô∏è‚É£ PAGAMENTO
  document.getElementById("btnPay").onclick = async () => {
    status("üí≥ Iniciando pagamento...");
    document.getElementById("btnPay").disabled = true;

    try {
      txHash = await payForAnalysis(fixtureId);
      status(`‚úÖ Pagamento confirmado\nTX: ${txHash}`);
      document.getElementById("btnAnalyze").disabled = false;
    } catch (e) {
      status("‚ùå Falha no pagamento");
    }
  };

  // 4Ô∏è‚É£ AN√ÅLISE
  document.getElementById("btnAnalyze").onclick = async () => {
    status("üìä Buscando an√°lise...");

    const res = await fetch(`${BACKEND}/analysis`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        apiKey: API_KEY,
        fixtureId,
        wallet,
        txHash
      })
    });

    const json = await res.json();
    output(json);
    status("‚úÖ An√°lise conclu√≠da");
  };
</script>

</body>
</html>
