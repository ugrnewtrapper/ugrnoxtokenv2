<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Teste V12 – Integração Completa</title>
  <style>
    body { font-family: Arial, sans-serif; }
    select { width: 100%; height: 140px; }
    pre { background: #111; color: #0f0; padding: 10px; overflow: auto; }
  </style>
</head>
<body>

<h2>Teste V12 – Wallet + Backend</h2>

<label>API Key:</label><br>
<input id="apiKey" style="width: 100%;" /><br><br>

<label>Data:</label><br>
<input id="date" type="date" /><br><br>

<button id="load">Carregar partidas</button>

<br><br>

<label>Partidas:</label><br>
<select id="fixtures"></select>

<br><br>

<button id="analyze">Analisar</button>

<h3>Resultado:</h3>
<pre id="output"></pre>

<script type="module">
  import { WalletV12 } from "./money/walletv12.js";

  const API_BASE = "https://backendv12.srrimas2017.workers.dev";

  const apiKeyInput = document.getElementById("apiKey");
  const dateInput = document.getElementById("date");
  const fixturesSelect = document.getElementById("fixtures");
  const output = document.getElementById("output");

  const wallet = new WalletV12();

  document.getElementById("load").onclick = async () => {
    output.textContent = "Carregando partidas...";

    const res = await fetch(`${API_BASE}/api/partidas`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        apiKey: apiKeyInput.value,
        date: dateInput.value
      })
    });

    const json = await res.json();
    fixturesSelect.innerHTML = "";

    if (!json.data?.length) {
      output.textContent = "Nenhuma partida encontrada.";
      return;
    }

    json.data.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f.fixture.id;
      opt.textContent =
        `${f.league.name} | ${f.teams.home.name} x ${f.teams.away.name}`;
      fixturesSelect.appendChild(opt);
    });

    output.textContent = "Partidas carregadas.";
  };

  document.getElementById("analyze").onclick = async () => {
    try {
      output.textContent = "Conectando carteira...";
      await wallet.connect();

      output.textContent = "Processando pagamento...";
      const payment = await wallet.pay();

      output.textContent = "Pagamento confirmado. Solicitando análise...";

      const res = await fetch(`${API_BASE}/api/analisar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          apiKey: apiKeyInput.value,
          fixtureId: Number(fixturesSelect.value),
          txHash: payment.txHash
        })
      });

      const json = await res.json();
      output.textContent = JSON.stringify(json, null, 2);
    } catch (err) {
      output.textContent = "ERRO:\n" + err.message;
    }
  };
</script>

</body>
</html>
