<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>V12 – HTML Teste Real</title>
</head>

<body>

<h3>V12 – Teste</h3>

<input id="apiKey" placeholder="API Key API-Football"><br><br>

<input type="date" id="date"><br><br>

<button id="loadCompetitions">Carregar competições</button><br><br>

<select id="fixtures"></select><br><br>

<button id="analyze">Analisar</button>

<pre id="out"></pre>

<script type="module">
  import { WalletV12 } from "./money/walletv12.js";
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.2/+esm";

  const out = document.getElementById("out");
  const log = x => out.textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2);

  const wallet = new WalletV12();

  document.getElementById("loadCompetitions").onclick = async () => {
    const apiKey = apiKey.value;
    const date = date.value;

    if (!apiKey || !date) return log("API Key ou data ausente");

    const res = await fetch("/api/partidas", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ apiKey, date })
    });

    const json = await res.json();
    if (json.error) return log(json);

    fixtures.innerHTML = "";
    json.data.forEach(f => {
      const o = document.createElement("option");
      o.value = f.fixture.id;
      o.textContent = `${f.teams.home.name} x ${f.teams.away.name}`;
      fixtures.appendChild(o);
    });

    log("Partidas carregadas");
  };

  document.getElementById("analyze").onclick = async () => {
    const apiKey = apiKey.value;
    const fixtureId = Number(fixtures.value);

    if (!fixtureId) return log("Selecione uma partida");

    try {
      const user = await wallet.connect();
      log("Carteira: " + user);

      const payment = await wallet.pay();
      log("Pagamento OK: " + payment.txHash);

      const res = await fetch("/api/analisar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ apiKey, fixtureId, txHash: payment.txHash })
      });

      const json = await res.json();
      log(json);
    } catch (e) {
      log(e.message);
    }
  };
</script>

</body>
</html>
