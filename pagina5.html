<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>V12 – Teste Oficial</title>

  <style>
    body {
      background:#0f1216;
      color:#e6e6e6;
      font-family:Arial, sans-serif;
      padding:20px;
    }
    .box {
      background:#151a21;
      padding:15px;
      margin-bottom:15px;
      border-radius:6px;
    }
    input, select, button {
      width:100%;
      padding:8px;
      margin-top:5px;
    }
    button {
      background:#1f6feb;
      border:none;
      color:#fff;
      cursor:pointer;
    }
    button:disabled {
      background:#555;
      cursor:not-allowed;
    }
    pre {
      background:#000;
      padding:10px;
      max-height:200px;
      overflow:auto;
      font-size:12px;
    }
  </style>
</head>
<body>

<h2>V12 – HTML de Teste (Correspondência Real)</h2>

<div class="box">
  <label>API Key (API-Football)</label>
  <input id="apiKey" placeholder="Cole sua API Key" />
</div>

<div class="box">
  <label>País</label>
  <input id="country" value="Brazil" />
</div>

<div class="box">
  <button id="loadLeagues">Carregar Competições</button>
  <select id="leagueSelect">
    <option value="">Selecione a competição</option>
  </select>
</div>

<div class="box">
  <label>Data da Partida</label>
  <input type="date" id="date" />
  <button id="loadMatches">Carregar Partidas</button>
</div>

<div class="box">
  <select id="fixtureSelect">
    <option value="">Selecione a partida</option>
  </select>
</div>

<div class="box">
  <button id="connectWallet">Conectar Carteira</button>
  <button id="analyze" disabled>Analisar (Pagamento + Análise)</button>
</div>

<div class="box">
  <strong>Resposta</strong>
  <pre id="output"></pre>
</div>

<script type="module">
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.2/+esm";
  import { WalletV12 } from "./money/walletv12.js";

  const wallet = new WalletV12();
  const out = document.getElementById("output");

  const log = obj => {
    out.textContent = typeof obj === "string"
      ? obj
      : JSON.stringify(obj, null, 2);
  };

  // ---------------- WALLET ----------------
  document.getElementById("connectWallet").onclick = async () => {
    try {
      const user = await wallet.connect();
      log("Carteira conectada: " + user);
      document.getElementById("analyze").disabled = false;
    } catch (e) {
      log(e.message);
    }
  };

  // ---------------- COMPETIÇÕES ----------------
  document.getElementById("loadLeagues").onclick = async () => {
    const apiKey = apiKeyInput.value;
    const country = countryInput.value;

    const res = await fetch("/api/competicoes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ apiKey, country })
    });

    const json = await res.json();
    if (json.error) return log(json);

    leagueSelect.innerHTML = `<option value="">Selecione a competição</option>`;
    json.data.forEach(l => {
      const opt = document.createElement("option");
      opt.value = l.league.id;
      opt.textContent = l.league.name;
      leagueSelect.appendChild(opt);
    });

    log("Competições carregadas");
  };

  // ---------------- PARTIDAS ----------------
  document.getElementById("loadMatches").onclick = async () => {
    const apiKey = apiKeyInput.value;
    const date = dateInput.value;

    const res = await fetch("/api/partidas", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ apiKey, date })
    });

    const json = await res.json();
    if (json.error) return log(json);

    fixtureSelect.innerHTML = `<option value="">Selecione a partida</option>`;
    json.data.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f.fixture.id;
      opt.textContent = `${f.teams.home.name} x ${f.teams.away.name}`;
      fixtureSelect.appendChild(opt);
    });

    log("Partidas carregadas");
  };

  // ---------------- ANÁLISE ----------------
  document.getElementById("analyze").onclick = async () => {
    const apiKey = apiKeyInput.value;
    const fixtureId = Number(fixtureSelect.value);

    if (!fixtureId) {
      return log("Selecione uma partida");
    }

    try {
      log("Pagamento em andamento...");
      const payment = await wallet.pay();

      const res = await fetch("/api/analisar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          apiKey,
          fixtureId,
          txHash: payment.txHash
        })
      });

      const json = await res.json();
      log(json);
    } catch (e) {
      log(e.message);
    }
  };

  // aliases DOM
  const apiKeyInput = document.getElementById("apiKey");
  const countryInput = document.getElementById("country");
  const leagueSelect = document.getElementById("leagueSelect");
  const dateInput = document.getElementById("date");
  const fixtureSelect = document.getElementById("fixtureSelect");
</script>

</body>
</html>
