<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>V12 ‚Äì Teste T√©cnico (Sem Carteira)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
    }
    button {
      background: #2563eb;
      border: none;
      color: white;
      cursor: pointer;
    }
    .league {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #334155;
      border-radius: 6px;
    }
    .fixture {
      padding: 6px;
      cursor: pointer;
      border-bottom: 1px solid #334155;
    }
    .fixture:hover {
      background: #1e293b;
    }
    .selected {
      background: #22c55e;
      color: #020617;
    }
    pre {
      background: #020617;
      padding: 10px;
      margin-top: 10px;
      max-height: 300px;
      overflow: auto;
    }
  </style>
</head>
<body>

<h1>V12 ‚Äì Teste T√©cnico (Sem Carteira)</h1>

<h3>1Ô∏è‚É£ API-Key (API-Football)</h3>
<input id="apiKey" placeholder="Cole sua API-Key">

<h3>2Ô∏è‚É£ Data do jogo</h3>
<input id="date" type="date">

<button onclick="carregar()">CARREGAR PARTIDAS</button>

<h3>3Ô∏è‚É£ Escolha a partida</h3>
<div id="lista"></div>

<button onclick="analisar()">ANALISAR PARTIDA</button>

<h3>üì¶ Resultado da An√°lise</h3>
<pre id="output"></pre>

<script>
const BASE = "https://backendv12.srrimas2017.workers.dev";
let fixtureSelecionado = null;

async function post(endpoint, body) {
  const res = await fetch(BASE + endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  return res.json();
}

async function carregar() {
  const apiKey = document.getElementById("apiKey").value;
  const date = document.getElementById("date").value;
  const lista = document.getElementById("lista");
  lista.innerHTML = "Carregando...";

  const data = await post("/api/partidas", {
    apiKey,
    date,
    timezone: "America/Sao_Paulo"
  });

  if (data.error) {
    lista.innerHTML = data.message;
    return;
  }

  const grouped = {};
  data.data.forEach(f => {
    const league = `${f.league.name} (${f.league.country})`;
    grouped[league] ||= [];
    grouped[league].push(f);
  });

  lista.innerHTML = "";

  Object.entries(grouped).forEach(([league, fixtures]) => {
    const div = document.createElement("div");
    div.className = "league";
    div.innerHTML = `<strong>${league}</strong>`;

    fixtures.forEach(f => {
      const item = document.createElement("div");
      item.className = "fixture";
      item.textContent =
        `${f.teams.home.name} x ${f.teams.away.name} ‚Äî ${f.fixture.date.slice(11,16)}`;

      item.onclick = () => {
        document.querySelectorAll(".fixture").forEach(e => e.classList.remove("selected"));
        item.classList.add("selected");
        fixtureSelecionado = f.fixture.id;
      };

      div.appendChild(item);
    });

    lista.appendChild(div);
  });
}

async function analisar() {
  if (!fixtureSelecionado) {
    alert("Selecione uma partida");
    return;
  }

  const apiKey = document.getElementById("apiKey").value;

  // üîì TXHASH FAKE (DEV ONLY)
  const txHashFake =
    "DEV_" + Date.now() + "_" + Math.random().toString(16).slice(2);

  const data = await post("/api/analisar", {
    apiKey,
    fixtureId: fixtureSelecionado,
    txHash: txHashFake
  });

  document.getElementById("output").textContent =
    JSON.stringify(data, null, 2);
}
</script>

</body>
</html>
