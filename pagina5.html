<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Teste de Integração V12</title>
  <style>
    body {
      font-family: monospace;
      background: #111;
      color: #eee;
      padding: 20px;
    }
    button {
      margin-right: 10px;
      padding: 8px 12px;
      font-family: monospace;
    }
    pre {
      background: #000;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      border: 1px solid #444;
    }
  </style>
</head>
<body>

<h2>Teste de Integração — V12</h2>

<button id="init">Inicializar</button>
<button id="run">Executar Fluxo Completo</button>
<button id="reset">Resetar</button>

<pre id="log"></pre>

<script type="module">
/* ============================================================
 * UTILITÁRIOS DE LOG (OBSERVAÇÃO, NÃO CORREÇÃO)
 * ============================================================
 */

const logEl = document.getElementById("log");

function log(...args) {
  console.log(...args);
  logEl.textContent += args.map(a =>
    typeof a === "string" ? a : JSON.stringify(a, null, 2)
  ).join(" ") + "\n";
}

window.addEventListener("error", e => {
  log("[ERRO NÃO TRATADO]", e.message);
});

window.addEventListener("unhandledrejection", e => {
  log("[PROMISE NÃO TRATADA]", e.reason);
});

/* ============================================================
 * CARREGAMENTO DOS CÓDIGOS (ORDEM EXPLÍCITA)
 * ============================================================
 */

log("==> Início do carregamento dos módulos");

import { WalletV12 } from "./money/walletv12.js";
log("✔ walletv12.js carregado");

import { FlowOrchestratorV12 } from "./statistics/statisticsv12.js";
log("✔ flowOrchestratorV12.js carregado");

/*
 * statisticsv12.js NÃO é importado aqui,
 * pois é um Cloudflare Worker.
 * Ele será testado via chamadas HTTP reais.
 */

log("==> Fim do carregamento dos módulos");

/* ============================================================
 * EXPOSIÇÃO GLOBAL (SEM CRIAR NADA NOVO)
 * ============================================================
 */

window.WalletV12 = WalletV12;
window.FlowOrchestratorV12 = FlowOrchestratorV12;

log("Objetos expostos em window:", {
  WalletV12: typeof WalletV12,
  FlowOrchestratorV12: typeof FlowOrchestratorV12
});

/* ============================================================
 * INSTÂNCIA DE TESTE
 * ============================================================
 */

let orchestrator = null;

document.getElementById("init").onclick = () => {
  log("==> Inicialização do Orquestrador");

  orchestrator = new FlowOrchestratorV12({
    apiBaseUrl: "http://localhost:8787" // ajuste conforme o Worker
  });

  log("Orquestrador criado:", orchestrator);
};

document.getElementById("run").onclick = async () => {
  if (!orchestrator) {
    log("⚠ Orquestrador não inicializado");
    return;
  }

  log("==> INÍCIO DO FLUXO COMPLETO");

  // ⚠ Valores reais devem ser inseridos manualmente
  const API_KEY = "SUA_API_KEY_AQUI";
  const DATE = "2024-01-01";

  log("[1] Setando API Key");
  orchestrator.setApiKey(API_KEY);

  log("[2] Setando data");
  orchestrator.setDate(DATE);

  log("[3] Carregando competições");
  const competitions = await orchestrator.loadCompetitions();
  log("Competições retornadas:", competitions.length);

  log("[4] Carregando partidas");
  const fixtures = await orchestrator.loadFixtures();
  log("Partidas retornadas:", fixtures.length);

  const fixture = fixtures[0];
  log("[5] Selecionando partida:", fixture);

  orchestrator.selectFixture(fixture);

  log("[6] Executando pagamento (wallet)");
  const payment = await orchestrator.payForAnalysis();
  log("Pagamento retornado:", payment);

  log("[7] Executando análise");
  const analysis = await orchestrator.runAnalysis();
  log("Resultado da análise:", analysis);

  log("==> FIM DO FLUXO COMPLETO");
};

document.getElementById("reset").onclick = () => {
  log("==> RESET MANUAL");
  orchestrator = null;
  logEl.textContent = "";
};
</script>

</body>
</html>
