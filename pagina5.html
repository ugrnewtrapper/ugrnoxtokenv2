<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Teste Avançado walletv12</title>
  <style>
    body { font-family: monospace; }
    button { margin: 6px 0; }
    .ok { color: green; }
    .err { color: red; }
    .step { color: blue; }
  </style>
</head>
<body>

<h3>Teste walletv12.js</h3>

<label>fixtureId:</label><br>
<input id="fixture" value="123456" /><br><br>

<label>apiKey:</label><br>
<input id="apiKey" value="TEST_API_KEY" /><br><br>

<button id="btnPay">1️⃣ Pagar + Analisar</button>
<button id="btnOnlyFetch">2️⃣ Apenas backend (sem pagar)</button>
<button id="btnClear">Limpar log</button>

<pre id="log"></pre>

<script type="module">
  import { payAndAnalyze } from "./money/walletv12.js";

  const logEl = document.getElementById("log");
  const log = (msg, cls = "") => {
    logEl.innerHTML += `%c${msg}\n`;
    console.log(msg);
  };

  const step = (m) => log(`▶ ${m}`, "step");
  const ok = (m) => log(`✔ ${m}`, "ok");
  const err = (m) => log(`✖ ${m}`, "err");

  document.getElementById("btnClear").onclick = () => {
    logEl.textContent = "";
  };

  document.getElementById("btnPay").onclick = async () => {
    const fixtureId = fixture.value;
    const apiKey = apiKeyInput.value;

    step("Iniciando payAndAnalyze()");

    try {
      const res = await payAndAnalyze(fixtureId, apiKey);
      ok("Resposta do backend:");
      log(JSON.stringify(res, null, 2));
    } catch (e) {
      err("Erro capturado:");
      err(e.message || e);
    }
  };

  document.getElementById("btnOnlyFetch").onclick = async () => {
    const fixtureId = fixture.value;
    const apiKey = apiKeyInput.value;

    step("Teste direto do backend (sem pagamento)");

    try {
      const res = await fetch(
        "https://backendv12.srrimas2017.workers.dev/analysis",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            apiKey,
            fixtureId,
            wallet: "0xTESTE",
            txHash: "0xTESTE"
          })
        }
      );

      const data = await res.json();
      ok("Resposta backend:");
      log(JSON.stringify(data, null, 2));
    } catch (e) {
      err("Erro no fetch direto:");
      err(e.message);
    }
  };
</script>

</body>
</html>
