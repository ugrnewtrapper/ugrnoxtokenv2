<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Teste Backend V12</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    label { display: block; margin-top: 10px; }
    input, select, button { margin-top: 5px; padding: 5px; width: 100%; }
    pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
  </style>
</head>

<body>
<h2>Teste Backend V12 – API-Football</h2>

<label>API Key:</label>
<input type="text" id="apiKey" placeholder="Digite sua API Key" />

<label>Data do jogo (YYYY-MM-DD):</label>
<input type="date" id="date" />

<button id="loadMatches">Carregar Competições e Partidas</button>

<label>Selecione a partida:</label>
<select id="fixtureSelect">
  <option value="">Nenhuma partida carregada</option>
</select>

<button id="analyze">Analisar Partida (Wallet Test)</button>

<h3>Resultado:</h3>
<pre id="result"></pre>

<script type="module">
  import { validatePaymentAndRequestAnalysis } from "./money/walletv12.js";

  const backendUrl = "https://backendv12.srrimas2017.workers.dev";

  const apiKeyInput = document.getElementById("apiKey");
  const dateInput = document.getElementById("date");
  const loadBtn = document.getElementById("loadMatches");
  const fixtureSelect = document.getElementById("fixtureSelect");
  const analyzeBtn = document.getElementById("analyze");
  const resultPre = document.getElementById("result");

  let loadedFixtures = [];

  // ================================
  // Carregar partidas (INALTERADO)
  // ================================
  loadBtn.addEventListener("click", async () => {
    const apiKey = apiKeyInput.value.trim();
    const date = dateInput.value.trim();

    if (!apiKey || !date) {
      alert("Informe API Key e Data do jogo.");
      return;
    }

    resultPre.textContent = "Carregando partidas...";

    try {
      const res = await fetch(`${backendUrl}/api/partidas`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ apiKey, date })
      });

      const data = await res.json();
      if (!res.ok) {
        resultPre.textContent = JSON.stringify(data, null, 2);
        return;
      }

      loadedFixtures = data.data;
      fixtureSelect.innerHTML = "";

      if (loadedFixtures.length === 0) {
        fixtureSelect.innerHTML = `<option value="">Nenhuma partida encontrada</option>`;
        resultPre.textContent = "Nenhuma partida encontrada para esta data.";
        return;
      }

      loadedFixtures.forEach(f => {
        const option = document.createElement("option");
        option.value = f.fixture.id;
        option.textContent = `${f.teams.home.name} x ${f.teams.away.name} (${f.league.name})`;
        fixtureSelect.appendChild(option);
      });

      resultPre.textContent = `Carregadas ${loadedFixtures.length} partidas.`;
    } catch (err) {
      resultPre.textContent = `Erro: ${err.message}`;
    }
  });

  // ================================
  // Analisar partida (ÚNICA MUDANÇA)
  // ================================
  analyzeBtn.addEventListener("click", async () => {
    const apiKey = apiKeyInput.value.trim();
    const fixtureId = fixtureSelect.value;

    if (!apiKey || !fixtureId) {
      alert("Informe API Key e selecione uma partida.");
      return;
    }

    resultPre.textContent = "Analisando partida (wallet test)...";

    try {
      const result = await validatePaymentAndRequestAnalysis({
        apiKey,
        fixtureId,
        txHash: "DEV_TX" // modo teste da carteira
      });

      resultPre.textContent = JSON.stringify(result, null, 2);
    } catch (err) {
      resultPre.textContent = `Erro: ${err.message}`;
    }
  });
</script>

</body>
</html>
